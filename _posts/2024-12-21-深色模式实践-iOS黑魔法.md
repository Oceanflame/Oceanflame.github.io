---
title: "深色模式实践-iOS黑魔法"
date: 2024-12-21 00:00:00 +0800
categories: [iOS, 深色模式]
tags: [iOS, 深色模式]
---

本文主要记录iOS众多黑魔法中的其中两位，关联对象和方法交换。

# 背景

经过前期的方案调研后，我最开始想到的方案如下：

大致的思路是用哈希表记录所有的控制器的view和继承自UIView的控件。每次创建控件时，添加到哈希表中。每次切换深色模式时，将哈希表中的所有控件遍历解包，不同类型的控件对其属性做不同处理。

哈希表是采用NSHashTable对控件弱持有，这样不需要关心每个控件的生命周期，不会引起循环引用。至于每个控件的话，不同控件属性的属性不一样，比如UIlabel有textColor和backgroundColor，项目内是否都使用了这两个属性，都使用就要都切换，那么每个控件都写一个基类，例如BaseLable继承自系统的UILabel，在基类里记录每个属性的颜色名字。

但是显然这样的方案在讨论时就会被毙掉，如果重写基类，首先工作量就很大，项目内的控件都要替换一遍，还要设置新的方法，还要让同事适应新的设置颜色方法，因为旧方法没法设置颜色信息设置颜色信息，如此多的改变是很难让大家适应的。
既然不能重写基类的话，总要有记录颜色名的载体，所以只能想办法把颜色名记录在UIColor对象中了。

iOS13系统开始提供了动态颜色对象，可以为UIColor设置两到三个颜色值，分别在light，dark和unspecified三种情况下返回不同的色值。如果设计师的颜色规范表都是单色的话，动态颜色倒也可以满足需求，然而事情没有想象的简单，颜色规范表除了单色还有渐变色，有些渐变色要用CAGradientLayer绘制，且CGColor是没有动态颜色的。显然这个方案并不能满足需求。

UIColor是系统的类，只能用extension进行扩展，可是extension中不能添加属性，这就很难受了，至此，第一项黑魔法登场

## 关联对象（AssociatedObject）

关联对象可以实现在一个类的extension中创建一个变量，这个变量是运行时的变量，并不是这个类编译时就声明的，算是变相实现了在分类中为类创建属性，这样就不用创建一个子类了，是不是很完美。

关联对象的设置方法
